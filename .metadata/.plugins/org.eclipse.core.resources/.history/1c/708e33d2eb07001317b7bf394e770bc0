package Generator;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

import ActivationManager.EventCandidate;
import ActivationManager.EventCandidateContainer;
import Bing.StaticMap;
import Common.Photo;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.graphics.Rect;
import android.os.Environment;

public class MapCollageBuilder {

	public static File BuildCollage(Template template) {

		Canvas canvas = null;
		FileOutputStream fos = null;
		Bitmap bmpBase = null;

		bmpBase = Bitmap.createBitmap(3264, 2448, Bitmap.Config.RGB_565);
		canvas = new Canvas(bmpBase);

		int photoC = 0;
		for (EventCandidate  eventCandidate : EventCandidateContainer.getInstance().getAllEventsInContainer()) {

			for (Photo photo : eventCandidate.getEventPhotos()) {
				if (photoC > 7 )
					break;

				BitmapFactory.Options options = new BitmapFactory.Options();
				options.inPreferredConfig = Bitmap.Config.ARGB_8888;
				Bitmap bitmap = BitmapFactory.decodeFile(photo.getFilePath(), options);

				PixelPoint topleftPixelPoint = template.getSlot(photoC).getTopLeft();
				PixelPoint bottomRightPixelPoint =  template.getSlot(photoC++).getBottomRight();

				canvas.drawBitmap(bitmap,
						new Rect(0, 0, bitmap.getWidth(), bitmap.getHeight()), // take all source photo
						new Rect(topleftPixelPoint.getX(), // place in output photo
								topleftPixelPoint.getY(),
								bottomRightPixelPoint.getX(), 
								bottomRightPixelPoint.getY()), 
								null);
			}
		}
		
		// draw Bing map into output
		
		BitmapFactory.Options options = new BitmapFactory.Options();
		options.inPreferredConfig = Bitmap.Config.ARGB_8888;
		Bitmap bitmap = BitmapFactory.decodeFile(template.getMapSlot().getPhotoPath(), options);

		PixelPoint topleftPixelPoint = template.getMapSlot().getTopLeft();
		PixelPoint bottomRightPixelPoint =  template.getMapSlot().getBottomRight();

		canvas.drawBitmap(bitmap,
				new Rect(0, 0, bitmap.getWidth(), bitmap.getHeight()), // take all source photo
				new Rect(topleftPixelPoint.getX(), // place in output photo
						topleftPixelPoint.getY(),
						bottomRightPixelPoint.getX(), 
						bottomRightPixelPoint.getY()), 
						null);
		
		Paint paint = new Paint(Paint.ANTI_ALIAS_FLAG);
		paint.setColor(android.graphics.Color.MAGENTA);
		paint.setStrokeWidth(3f);
		canvas.drawLine(642, 2080, 2448, 642, paint);
		
		File externalStorageDir = new File(Environment.getExternalStorageDirectory(), "Pictures");
		File testsDir = new File(externalStorageDir.getAbsolutePath() + File.separator + "Output");
		File file = null;
		
		// Save Bitmap to File
		try
		{
			file = new File(testsDir, "output.jpg");
			
			fos = new FileOutputStream(file);
			bmpBase.compress(Bitmap.CompressFormat.JPEG, 100, fos);

			fos.flush();
			fos.close();
			fos = null;
		}
		catch (IOException e)
		{
			e.printStackTrace();
		}
		finally
		{
			if (fos != null)
			{
				try
				{
					fos.close();
					fos = null;
				}
				catch (IOException e)
				{
					e.printStackTrace();
				}
			}
			
		}
		
		return file;
	}
	
	private static addImageToCanvas(Canvas canvas, Template template) {
		BitmapFactory.Options options = new BitmapFactory.Options();
		options.inPreferredConfig = Bitmap.Config.ARGB_8888;
		Bitmap bitmap = BitmapFactory.decodeFile(template.getMapSlot().getPhotoPath(), options);

		PixelPoint topleftPixelPoint = template.getMapSlot().getTopLeft();
		PixelPoint bottomRightPixelPoint =  template.getMapSlot().getBottomRight();

		canvas.drawBitmap(bitmap,
				new Rect(0, 0, bitmap.getWidth(), bitmap.getHeight()), // take all source photo
				new Rect(topleftPixelPoint.getX(), // place in output photo
						topleftPixelPoint.getY(),
						bottomRightPixelPoint.getX(), 
						bottomRightPixelPoint.getY()), 
						null);
	}

}

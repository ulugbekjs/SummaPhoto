package Generator;

import java.io.IOException;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import ActivationManager.DedicatedRequest;
<<<<<<< HEAD
import Bing.Pushpin;
=======
>>>>>>> 90f8a1fc5b2538a73cc6a0b8f1aa5ea1b7910d27
import Common.ActualEventsBundle;
import Common.Photo;
import android.R.integer;
import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.util.Log;

public class MapCollageBuilder extends AbstractBuilder{
	
	MapTemplate template = null;
	
	private static final String TAG = MapCollageBuilder.class.getName();

	public MapCollageBuilder(ActualEventsBundle bundle) {
		super(bundle);
		// TODO Auto-generated constructor stub
	}

	@Override
	public Photo buildCollage() {

		Canvas canvas = null;
		Bitmap bmpBase = null;

		bmpBase = Bitmap.createBitmap(3264, 2448, Bitmap.Config.RGB_565);
		canvas = new Canvas(bmpBase);

		// draw images saved in Template onto canvas
		for (int slot = 0; slot < template.getNumberOfSlots(); slot ++) {
			try {
				addSlotImageToCanvas(canvas, template.getSlot(slot));
			}
			catch (NullPointerException exception) {
				// TODO: deal with error
			}
		}

		// draw Bing map into output
		try {
			addSlotImageToCanvas(canvas, template.getMapSlot());
		}
		catch (NullPointerException exception) {
			//TODO: deal with error
		}

		// add lines
		Paint paint = new Paint(Paint.ANTI_ALIAS_FLAG);
		paint.setColor(android.graphics.Color.MAGENTA);
		paint.setStrokeWidth(3f);
		canvas.drawLine(642, 2080, 2448, 642, paint);

		Photo collage;
		try {
			collage = saveCollage(bmpBase);
		}
		catch (IOException exception) {
			Log.e(TAG, "Error when saving collage file");
			// TODO: notify user about error in saving collage
			return null;
		}

		clearProcessPhotos(); // not to reuse same photos
		
		return collage;
	}

	@Override
	public boolean populateTemplate() {
		
		template = MapTemplate.getTemplate(2);
		Set<PixelPoint> connectionPixelPoints = template.getLinesConnectionPoints();
		
		// TODO Auto-generated method stub
		return false;
	}
	
	@Override
	public DedicatedRequest setTemplate() {
		// TODO Auto-generated method stub
		return null;
	}
	
	/**
	 * @param pushPins - the list of pushPins on map retrieved from bing
	 * @return list which contains the actual pixel of the pushPin in the output colage 
	 */
	
	private Set<PixelPoint> adjustPushPinsLocationToMap(List<Pushpin> pushPins)
	{
		if (pushPins == null)
			return null;
		Integer xInterval = template.getMapSlot().getTopLeft().getX();
		Integer yInterval = template.getMapSlot().getTopLeft().getY();
		Set<PixelPoint> adjustedPushPinsPixelPoints = new HashSet<PixelPoint>();
		
		// the adjusted pixel point for each pushPin its is originalX + the top left X coordinate of the map (the same for Y coordinate)
		for (Pushpin pin: pushPins)
		{
			adjustedPushPinsPixelPoints.add(new PixelPoint(xInterval + pin.getAnchor().getX(), yInterval + pin.getAnchor().getY()));
		}
		return adjustedPushPinsPixelPoints ;
	}
	
	
	
}
